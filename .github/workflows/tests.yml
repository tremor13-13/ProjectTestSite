name: ğŸš€ Run Autotests

#  Ğ˜Ğ—ĞœĞ•ĞĞ¯Ğ•Ğœ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ workflow_dispatch
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:    #  Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
    inputs:
      test_type:
        description: 'Select test type to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - smoke
        - regression

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Build Docker image
      run: docker build -t my-autotests .
      timeout-minutes: 8

    #  Ğ—ĞĞœĞ•ĞĞ¯Ğ•Ğœ Ğ´Ğ²Ğ° ÑˆĞ°Ğ³Ğ° Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ ÑƒĞ¼Ğ½Ñ‹Ğ¹
    - name: ğŸ§ª Run Tests
      run: |
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ°ĞºĞ¸Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ
        if [ "${{ github.event.inputs.test_type }}" == "smoke" ]; then
          echo "ğŸš€ Running SMOKE tests"
          TEST_COMMAND="pytest -v -m smoke"
        elif [ "${{ github.event.inputs.test_type }}" == "regression" ]; then
          echo "ğŸ” Running REGRESSION tests" 
          TEST_COMMAND="pytest -v -m regression"
        else
          echo "ğŸ¯ Running ALL tests"
          TEST_COMMAND="pytest -v"
        fi
        
        docker run \
          -e LOGIN="${{ secrets.LOGIN }}" \
          -e PASSWORD="${{ secrets.PASSWORD }}" \
          -v $(pwd)/allure-results:/app/allure-results \
          my-autotests $TEST_COMMAND
      timeout-minutes: 10

    # ĞÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑˆĞ°Ğ³Ğ¸ Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
    - name: ğŸ“¦ Install Allure
      run: |
        sudo apt-get update
        sudo apt-get install -y default-jre
        wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
        sudo tar -zxvf allure-2.27.0.tgz -C /opt/
        sudo ln -sf /opt/allure-2.27.0/bin/allure /usr/bin/allure

    - name: ğŸ“Š Generate Allure Report
      run: allure generate allure-results -o allure-report --clean

    - name: ğŸš€ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¤ Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./allure-report

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: run-tests
    steps:
      - name: ğŸ¯ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

## ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ² ĞĞºÑ‚Ğ¸Ğ¾Ğ½Ñ Ğ±ĞµĞ· Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ Ğ¿ÑƒÑˆÑƒ
#name: ğŸš€ Run Autotests
#
#on: [push, pull_request]
#
#permissions:
#  contents: write
#  pages: write
#  id-token: write
#
#jobs:
#  run-tests:
#    runs-on: ubuntu-latest
#    timeout-minutes: 15
#
#    steps:
#    - name: ğŸ“¥ Checkout code
#      uses: actions/checkout@v4
#
#    - name: ğŸ³ Build Docker image
#      run: docker build -t my-autotests .
#      timeout-minutes: 8
#
#    - name: ğŸ§ª Run tests
#      run: |
#        docker run \
#          --network=host \
#          -e LOGIN="${{ secrets.LOGIN }}" \
#          -e PASSWORD="${{ secrets.PASSWORD }}" \
#          -v $(pwd)/allure-results:/app/allure-results \
#          my-autotests
#      timeout-minutes: 5
#
#    - name: ğŸ“¦ Install Allure
#      run: |
#        sudo apt-get update
#        sudo apt-get install -y default-jre
#        wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
#        sudo tar -zxvf allure-2.27.0.tgz -C /opt/
#        sudo ln -sf /opt/allure-2.27.0/bin/allure /usr/bin/allure
#
#    - name: ğŸ“Š Generate Allure Report
#      run: allure generate allure-results -o allure-report --clean
#
#    - name: ğŸš€ Setup Pages
#      uses: actions/configure-pages@v4
#
#    - name: ğŸ“¤ Upload to Pages
#      uses: actions/upload-pages-artifact@v3
#      with:
#        path: ./allure-report
#
#  deploy:
#    environment:
#      name: github-pages
#      url: ${{ steps.deployment.outputs.page_url }}
#    runs-on: ubuntu-latest
#    needs: run-tests
#    steps:
#      - name: ğŸ¯ Deploy to GitHub Pages
#        id: deployment
#        uses: actions/deploy-pages@v4

#name: ğŸš€ Run Autotests
#
#on: [push, pull_request]
#
#jobs:
#  run-tests:
#    runs-on: ubuntu-latest
#    timeout-minutes: 15
#
#    steps:
#    - name: ğŸ“¥ Checkout code
#      uses: actions/checkout@v4
#
#    - name: ğŸ³ Build Docker image
#      run: docker build -t my-autotests .
#      timeout-minutes: 8
#
#    - name: ğŸ§ª Run tests
#      run: docker run -v $(pwd)/allure-results:/app/allure-results my-autotests
#      timeout-minutes: 5
#
#    - name: ğŸ“Š Allure Report
#      uses: simple-elf/allure-report-action@v1.7
#      if: always()
#      with:
#        allure_results: allure-results
#        allure_report: allure-report
#        keep_reports: 5
#
#    - name: ğŸ“ Upload Allure Report
#      uses: actions/upload-artifact@v4
#      if: always()
#      with:
#        name: allure-report
#        path: allure-report/
#        retention-days: 30

#name: ğŸš€ Run Autotests
#
#on: [push, pull_request]
#
#jobs:
#  run-tests:
#    runs-on: ubuntu-latest
#    timeout-minutes: 15  # ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚
#
#    steps:
#    - name: ğŸ“¥ Checkout code
#      uses: actions/checkout@v4
#
#    - name: ğŸ³ Build Docker image
#      run: docker build -t my-autotests .
#      timeout-minutes: 8  # Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ½Ğ° ÑĞ±Ğ¾Ñ€ĞºÑƒ
#
#    - name: ğŸ§ª Run tests
#      run: docker run -v $(pwd)/allure-results:/app/allure-results my-autotests
#      timeout-minutes: 5  # Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ½Ğ° Ñ‚ĞµÑÑ‚Ñ‹
#
#    - name: ğŸ’¾ Upload Allure results
#      uses: actions/upload-artifact@v4
#      with:
#        name: allure-results
#        path: allure-results/